<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.10.18/css/dataTables.bootstrap4.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
  <link href="css/style.css" rel="stylesheet">
  <title>Weather Data</title>

  <script>
    let weather = [];
    let graphData = {
      'date' : [],
      'celsius' : [],
      'fahrenheit' : [],
      'humidity' : []
    }

    function load() {
      let ref = new Firebase('https://weather-data-90123-default-rtdb.firebaseio.com/Base/');
      let ct = 0;
      ref.on("child_added", function (data) {
        let newData = data.val();
        weather[ct] = [newData.date, parseFloat(newData.cTemp).toFixed(1), parseFloat(newData.fTemp).toFixed(1), parseFloat(newData.humidity).toFixed(1)];
        // console.log(weather);
        ct++;
      });
      (function countdown(remaining) {
        if(remaining <= 0)
          location.reload(true);
        document.getElementById('countdown').innerHTML = `Refreshing page in: ${remaining} seconds`;
        setTimeout(function(){ countdown(remaining - 1); }, 1000);
      })(240); // 5 seconds
    }

    function addRefresh(n) {
      setUpGraphData(n);
      document.getElementById("refresh").innerHTML = "<br><button type='button' class='btn btn-outline-danger' onclick='window.location.reload()'>Refresh Data</button>"
      table(n)
    }

    function table(n) {
      let oStr = "";
      let tempData; //Sets if it should be Celsius (t) or Fahrenheit (f)
      oStr += "<table class='table table-bordered table-hover ' id='dataTable'><thead class='thead-light'><tr><th>Time</th><th>Temperature</th><th>Humidity</th></tr></thead>";
      oStr += "<tbody>";
      let symbol;
      if (n) {
        tempData = 1;
        symbol = "&degC";
        document.getElementById("bt1").style.backgroundColor = "gray";
        document.getElementById("bt2").style.backgroundColor = "black";
      } else {
        tempData = 2;
        symbol = "&degF";
        document.getElementById("bt1").style.backgroundColor = "black";
        document.getElementById("bt2").style.backgroundColor = "gray";
      }
      for (let i = weather.length-1; i > 0; i--) {
        let data = weather[i];
        // console.log(data);
        oStr += "<tr>";
        oStr += `<td>${data[0]}</td>`;
        oStr += `<td>${data[tempData]}${symbol}</td>`;
        oStr += `<td>${data[3]}%</td>`;
        oStr += "</tr>";
      }
      oStr += "</tbody></table>";
      document.getElementById("chart").innerHTML = oStr;
      $('#dataTable').DataTable({
        "pageLength": 20,
        "paging": true,
        "lengthChange": false,
        "searching": false,
        "ordering": false,
        "info": true,
        "autoWidth": true
      });
    }

    function setUpGraphData (type) {
      let ct = 0;
      for(let i = weather.length-20; i<weather.length; i++) {
        let data = weather[i];
        // console.log(`${weather[i]}`);

        graphData.date[ct] = data[0];
        graphData.celsius[ct] = data[1];
        graphData.fahrenheit[ct] = data[2];
        graphData.humidity[ct] = data[3];
        ct++;
      }
      document.getElementById("myChart").style.maxHeight = "800px";
      let data;
      let label;
      if(type) {
        data = graphData.celsius;
        label = "Celsius"
      } else {
        data = graphData.fahrenheit;
        label = "Fahrenheit";
      }
      new Chart("myChart", {
        type: "line",
        data: {
          labels: graphData.date,
          datasets: [{
            label: label,
            data: data,
            borderColor: "red",
            fill: false
          },{
            label: "Humidity (%)",
            data: graphData.humidity,
            borderColor: "blue",
            fill: false
          }]
        },
        options: {
          legend: {display: true},
          scales: {
            xAxes: [{
              ticks: {
                autoSkip: false,
                maxRotation: 90,
                minRotation: 90
              }
            }],
            yAxes: [{
              ticks: {
                suggestedMin: 0,
                suggestedMax: 100
              }
            }]
          },
          tooltips: {
            mode: 'index',
            intersect: false
          },
          hover: {
            mode: 'index',
            intersect: false
          }
        }
      });
    }



  </script>
</head>
<body onload="load();">
<ul class="nav justify-content-center navbar-dark bg-dark">
  <li class="nav-item">
    <a class="nav-link active" aria-current="page" href="#">Data</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="images.html">Images</a>
  </li>

</ul>

<div class="text-center">
  <p id="countdown" style="position: absolute"></p> <br/>
  <p style="margin-top: 25px; margin-bottom: 10px">
    Choose unit of measure to view data:
  </p>
  <button type="button" id="bt1" class="btn btn-dark temperaturesBtns" onclick="addRefresh(false)">Fahrenheit</button>
  <button type="button" id="bt2" class="btn btn-dark temperaturesBtns" onclick="addRefresh(true)">Celsius</button>
  <span id="refresh"></span>
  <div class="container-fluid">
    <div class="row row-space">
      <div id="chart" class="col-md-5"></div>
      <div id="graph" class="col-md-7">
        <canvas id="myChart" style="width:100%;max-width:1000px; height: 800px; max-height: 0px"></canvas>
      </div>

    </div>
  </div>
</div>




<footer class="bg-light text-center">
  <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
    Â© 2022 Copyright - Andrew Musielak, Juan Munoz, and Stephanie Joanem
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>



</body>
</html>